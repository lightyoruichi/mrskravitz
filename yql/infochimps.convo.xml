<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd" https="true">
    <meta>
        <author>Steve Odom</author>
        <documentationURL></documentationURL>
				<sampleQuery>select * from infochimps.convo where sn="steveodom"</sampleQuery>
    </meta>
      <bindings>
        <select itemPath="" produces="JSON">
					<urls>
					   <url>http://api.infochimps.com/social/network/tw/graph/strong_links</url>
					</urls>
          <inputs>
						<key id="apikey" type="xs:string" paramType="query" required="true"/>
						<key id="sn" type="xs:string" paramType="query" required="true"/>
						<key id="v" type="xs:string" paramType="query" required="false"/>
          </inputs>
					<execute><![CDATA[
				
					function strong_links_query(sn) {
						var url = "http://api.infochimps.com/social/network/tw/graph/strong_links";
						var req = y.rest(url)
											 .accept('application/json')
											 .query("apikey", apikey)
											 .query("screen_name", sn)
											 .get().response;
					 return req
					}
					
					function twitter_query(tid) {
						var url = "http://api.twitter.com/1/users/show.json";
						var tw = y.rest(url)
											.query("id", tid)
											.accept('application/json')
											.get().response;
						// y.log(tw);
						return tw;
					};
					
					function place_query(location) {
						y.log(location);
						var q = "select * from geo.placefinder where text='" + encodeURIComponent(location) + "'";
						var req = y.query(q);
						
						return req.results.Result;
					};
				
					data = strong_links_query(sn);
					var obj = y.xmlToJson(data);
					// y.log(obj);
					var ids = obj.json.strong_links.slice(0,24);
					var items = <peeps></peeps>;
					for each (var p in ids){
							item = <peep></peep>;
							tw = twitter_query(p.json[0]);
							item.@["id"] = tw.id;
							item.@["name"] = tw.name;
							item.@["sn"] = tw.screen_name;
							item.@["location"] = tw.location;
							
							pl = place_query(tw.location);
							item.@["postal"] = pl.uzip;
							item.@["countrycode"] = pl.countrycode;
							item.@["location"] = pl.city + ", " + pl.statecode;
							items.node += item;
					}
		
					response.object = items;
				      ]]></execute>
        </select>
      </bindings>
</table>